{% extends "default/layouts/crud.twig" %}

{% block title %}Novo Usuário - {{ app_name }}{% endblock %}

{% block page_content %}
    <div class="page-header">
        <div>
            <h1>Novo Usuário</h1>
            <p class="page-subtitle">Preencha os dados para criar um novo usuário</p>
        </div>
        <a href="{{ url('users') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Voltar
        </a>
    </div>

    <div class="card">
        <div class="card-body">
            <form id="userForm" enctype="multipart/form-data" novalidate>
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="name">Nome Completo *</label>
                            <input type="text" class="form-control" id="name" name="name" required autofocus>
                            <div class="invalid-feedback"></div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="alias">Apelido</label>
                            <input type="text" class="form-control" id="alias" name="alias" maxlength="60">
                            <div class="invalid-feedback"></div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="email">Email *</label>
                            <input type="email" class="form-control" id="email" name="email" required>
                            <div class="invalid-feedback"></div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="cpf">CPF</label>
                            <input type="text" class="form-control" id="cpf" name="cpf" maxlength="14" placeholder="000.000.000-00">
                            <div class="invalid-feedback"></div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="birth_date">Data de Nascimento</label>
                            <input type="date" class="form-control" id="birth_date" name="birth_date">
                            <div class="invalid-feedback"></div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="gender_id">Gênero</label>
                            <select class="form-control" id="gender_id" name="gender_id">
                                <option value="">Selecione...</option>
                                <option value="1">Masculino</option>
                                <option value="2">Feminino</option>
                            </select>
                            <div class="invalid-feedback"></div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="phone_home">Telefone Residencial</label>
                            <input type="text" class="form-control" id="phone_home" name="phone_home" maxlength="15" placeholder="(00) 0000-0000">
                            <div class="invalid-feedback"></div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="phone_mobile">Celular</label>
                            <input type="text" class="form-control" id="phone_mobile" name="phone_mobile" maxlength="15" placeholder="(00) 00000-0000">
                            <div class="invalid-feedback"></div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="phone_message">WhatsApp</label>
                            <input type="text" class="form-control" id="phone_message" name="phone_message" maxlength="15" placeholder="(00) 00000-0000">
                            <div class="invalid-feedback"></div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="username">Username *</label>
                            <input type="text" class="form-control" id="username" name="username" required>
                            <div class="invalid-feedback"></div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <!-- Espaço vazio para manter layout -->
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="password">Senha *</label>
                            <input type="password" class="form-control" id="password" name="password" required>
                            <small class="form-text">Mínimo de 6 caracteres</small>
                            <div class="invalid-feedback"></div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="password_confirmation">Confirmar Senha *</label>
                            <input type="password" class="form-control" id="password_confirmation" name="password_confirmation" required>
                            <small class="form-text">Digite a senha novamente</small>
                            <div class="invalid-feedback"></div>
                        </div>
                    </div>
                </div>
                
                
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="status_id">Status *</label>
                            <select class="form-control" id="status_id" name="status_id" required>
                                {% for status in statuses %}
                                <option value="{{ status.id }}">{{ status.translate }}</option>
                                {% endfor %}
                            </select>
                            <div class="invalid-feedback"></div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="level_id">Nível de Acesso *</label>
                            <select class="form-control" id="level_id" name="level_id" required>
                                {% for level in levels %}
                                <option value="{{ level.id }}" {{ level.id == 11 ? 'selected' : '' }}>{{ level.translate }}</option>
                                {% endfor %}
                            </select>
                            <div class="invalid-feedback"></div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                            <label for="photo">Foto</label>
                            <div class="photo-upload-wrapper">
                                <input type="text" class="form-control photo-filename" id="photoFilename" readonly placeholder="Nenhum arquivo selecionado">
                                <input type="file" class="form-control" id="photo" name="photo" accept="image/*" style="display: none;">
                                <button type="button" class="btn btn-secondary btn-choose-file" onclick="document.getElementById('photo').click()">
                                    Escolher arquivo
                                </button>
                            </div>
                            <small class="form-text">Formatos: JPG, PNG, GIF, WEBP (máx: 5MB)</small>
                        </div>
                        
                        <!-- Preview da foto -->
                        <div class="photo-preview-container" id="photoPreviewContainer" style="display: none;">
                            <div class="photo-preview-box">
                                <img id="photoPreview" src="" alt="Preview">
                                <button type="button" class="btn btn-sm btn-danger btn-remove-preview" id="removePhoto">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i> Salvar
                    </button>
                    <a href="{{ url('users') }}" class="btn btn-secondary">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </a>
                </div>
            </form>
        </div>
    </div>
</main>

<script>
function toggleDropdown() {
    document.getElementById('userDropdown').classList.toggle('show');
}

function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('show');
}

function toggleSubmenu(element) {
    const submenu = element.nextElementSibling;
    const arrow = element.querySelector('.nav-arrow');
    submenu.classList.toggle('show');
    arrow.style.transform = submenu.classList.contains('show') ? 'rotate(180deg)' : 'rotate(0deg)';
}

window.onclick = function(event) {
    if (!event.target.closest('.user-menu')) {
        var dropdown = document.getElementById('userDropdown');
        if (dropdown && dropdown.classList.contains('show')) {
            dropdown.classList.remove('show');
        }
    }
}

// Máscaras de formatação
function maskCPF(value) {
    return value
        .replace(/\D/g, '')
        .replace(/(\d{3})(\d)/, '$1.$2')
        .replace(/(\d{3})(\d)/, '$1.$2')
        .replace(/(\d{3})(\d{1,2})$/, '$1-$2');
}

function maskPhone(value) {
    value = value.replace(/\D/g, '');
    if (value.length <= 10) {
        return value.replace(/(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3');
    } else {
        return value.replace(/(\d{2})(\d{5})(\d{0,4})/, '($1) $2-$3');
    }
}

// Validação de CPF
function validateCPF(cpf) {
    cpf = cpf.replace(/\D/g, '');
    
    if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) {
        return false;
    }
    
    let sum = 0;
    let remainder;
    
    for (let i = 1; i <= 9; i++) {
        sum += parseInt(cpf.substring(i - 1, i)) * (11 - i);
    }
    
    remainder = (sum * 10) % 11;
    if (remainder === 10 || remainder === 11) remainder = 0;
    if (remainder !== parseInt(cpf.substring(9, 10))) return false;
    
    sum = 0;
    for (let i = 1; i <= 10; i++) {
        sum += parseInt(cpf.substring(i - 1, i)) * (12 - i);
    }
    
    remainder = (sum * 10) % 11;
    if (remainder === 10 || remainder === 11) remainder = 0;
    if (remainder !== parseInt(cpf.substring(10, 11))) return false;
    
    return true;
}

// Preenche automaticamente o apelido com o primeiro nome
document.getElementById('name').addEventListener('input', function(e) {
    const fullName = e.target.value.trim();
    const firstName = fullName.split(' ')[0];
    document.getElementById('alias').value = firstName;
});

// Aplicar máscaras
document.getElementById('cpf').addEventListener('input', function(e) {
    e.target.value = maskCPF(e.target.value);
});

document.getElementById('phone_home').addEventListener('input', function(e) {
    e.target.value = maskPhone(e.target.value);
});

document.getElementById('phone_mobile').addEventListener('input', function(e) {
    e.target.value = maskPhone(e.target.value);
});

document.getElementById('phone_message').addEventListener('input', function(e) {
    e.target.value = maskPhone(e.target.value);
});

// Preview de foto
document.getElementById('photo').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        // Valida tipo
        if (!file.type.match('image.*')) {
            alert('Por favor, selecione uma imagem válida');
            e.target.value = '';
            return;
        }
        
        // Valida tamanho (5MB)
        if (file.size > 5242880) {
            alert('Imagem muito grande. Máximo: 5MB');
            e.target.value = '';
            return;
        }
        
        // Mostra nome do arquivo
        document.getElementById('photoFilename').value = file.name;
        
        // Mostra preview
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('photoPreview').src = e.target.result;
            document.getElementById('photoPreviewContainer').style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
});

// Remover foto
document.getElementById('removePhoto').addEventListener('click', function() {
    document.getElementById('photo').value = '';
    document.getElementById('photoFilename').value = '';
    document.getElementById('photoPreviewContainer').style.display = 'none';
});

document.getElementById('userForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Limpa erros anteriores
    document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
    
    // Validação de CPF
    const cpfInput = document.getElementById('cpf');
    if (cpfInput.value && !validateCPF(cpfInput.value)) {
        cpfInput.classList.add('is-invalid');
        cpfInput.nextElementSibling.textContent = 'CPF inválido';
        return;
    }
    
    // Validação de confirmação de senha
    const password = document.getElementById('password').value;
    const passwordConfirmation = document.getElementById('password_confirmation').value;
    
    if (password !== passwordConfirmation) {
        const confirmInput = document.getElementById('password_confirmation');
        confirmInput.classList.add('is-invalid');
        confirmInput.nextElementSibling.textContent = 'As senhas não coincidem';
        return;
    }
    
    // Usa FormData para enviar arquivo
    const formData = new FormData(this);
    
    fetch('{{ url('users') }}', {
        method: 'POST',
        body: formData // Envia como FormData, não JSON
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            window.location.href = data.redirect;
        } else {
            if (data.errors) {
                for (let field in data.errors) {
                    const input = document.getElementById(field);
                    if (input) {
                        input.classList.add('is-invalid');
                        input.nextElementSibling.textContent = data.errors[field];
                    }
                }
            } else {
                alert(data.message);
            }
        }
    })
    .catch(error => {
        alert('Erro ao salvar usuário');
        console.error(error);
    });
});
</script>
{% endblock %}
